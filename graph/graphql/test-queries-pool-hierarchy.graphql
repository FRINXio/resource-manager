# Test pool hierarchies
# Creates following hierarchy of ipv4 prefixes with ips at the end

#                                            +---------------------------+
#                                           |                           |
#                                           |  Name: 10.0.0.0/8         |
#                                           |  Type: Ipv4Prefix         |
#                                           |  Allocation strategy:     |
#                                           |   split_ipv4_prefix_in_2  |
#                                           |                           |
#                                           +--------------+------------+
#                                                          |
#                                                          |
#                                +-------------------------+------------------------------+
#                                |                                                        |
#                                |                                                        |
#                 +--------------+------------+                        +------------------+----------------+
#                 |                           |                        |                                   |
#                 |  Name: 10.0.0.0/9         |                        |  Name: 10.128.0.0/9               |
#                 |  Type: Ipv4Prefix         |                        |  Type: Ipv4Prefix                 |
#                 |  Allocation strategy:     |                        |  Set:                             |
#                 |   split_ipv4_prefix_in_2  |                        |   [10.128.0.0/10, 10.192.0.0/10]  |
#                 |                           |                        |                                   |
#                 +-------------+-------------+                        +------------------+----------------+
#                               |                                                         |
#                               |                                                         |
#              +----------------+----------------+                                    +---+----------------------------------+
#              |                                 |                                    |                                      |
#              |                                 |                                    |                                      |
#+-------------+-------------+     +-------------+-------------+       +--------------+------------+           +-------------+-------------+
#|                           |     |                           |       |                           |           |                           |
#|  Name: 10.0.0.0/10        |     |  Name: 10.64.0.0/10       |       |  Name: 10.128.0.0/10      |           |  Name: 10.192.0.0/10      |
#|  Type: Ipv4Prefix         |     |  Type: Ipv4               |       |  Type: Ipv4               |           |  Type: Ipv4               |
#|  Singleton: 10.0.0.0/11   |     |  Allocation strategy:     |       |  Allocation strategy:     |           |  Allocation strategy:     |
#|                           |     |   ipv4_from_subnet        |       |   ipv4_from_subnet        |           |   ipv4_from_subnet        |
#|         # Unused          |     |                           |       |                           |           |                           |
#+---------------------------+     +---------------------------+       +---------------------------+           +---------------------------+

mutation createResourceType_ipv4Prefix {
    CreateResourceType(
        resourceName: "ipv4_prefix",
        resourceProperties: {
            ip: "string",
            prefix: "int"
        }
    ) {
        ID
    }
}

mutation CreateIpv4PrefixAllocationStratJs {
    CreateAllocationStrategy(
        name: "ipv4_prefix_splitting_in_2",
        description: "This strategy can split a network prefix into 2 new prefixes equally sized"
        script: """

        function inet_ntoa(addrint) {
            return ((addrint >> 24) & 0xff) + "." +
            ((addrint >> 16) & 0xff) + "." +
            ((addrint >> 8) & 0xff) + "." +
            (addrint & 0xff);
        }

        function inet_aton(addrstr) {
            var re = /^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/;
            var res = re.exec(addrstr);

            if (res === null) {
                return null;
            }

            for (var i = 1; i <= 4; i++) {
                if (res[i] < 0 || res[i] > 255) {
                    return null;
                }
            }

            return (res[1] << 24) | (res[2] << 16) | (res[3] << 8) | res[4];
        }

        function subnet_addresses(mask)
        {
            return 1<<(32-mask);
        }

        const prefixRegex = /([0-9.]+)\/([0-9]{1,2})/;

        function parse_prefix(str) {
            let res = prefixRegex.exec(str);
            if (res == null) {
                return null
            }

            return {
                "address": res[1],
                "prefix": parseInt(res[2], 10)
            }
        }

        function invoke() {
            let rootPrefix = resourcePool.ResourcePoolName

            let rootPrefixParsed = parse_prefix(rootPrefix)
            if (rootPrefixParsed == null) {
                console.error("Unable to extract root prefix from pool name: " + rootPrefix)
                return
            }

            let addrStr = rootPrefixParsed.address
            let mask = rootPrefixParsed.prefix

            if (currentResources.length === 0) {
                return {
                    "ip": addrStr,
                    "prefix": mask +1
                }
            } else if (currentResources.length === 1) {
                let addrInt = inet_aton(addrStr);
                let newAddrInt = addrInt+subnet_addresses(mask+1)
                return {
                    "ip": inet_ntoa(newAddrInt),
                    "prefix": mask +1
                }
            } else {
                console.error("No more free resources")
            }
        }

        """,
        lang: js
    ){
        ID
    }
}

mutation TestAllocationStrat_ipv4Prefix {
    TestAllocationStrategy(
        allocationStrategyId: 1,
        resourcePool: { ResourcePoolName: "10.0.0.0/8"},
        currentResources: [],
        userInput: {})
}

mutation TestAllocationStrat_ipv4Prefix_2 {
    TestAllocationStrategy(
        allocationStrategyId: 1,
        resourcePool: { ResourcePoolName: "10.0.0.0/8"},
        currentResources: [{Properties: { prefix: 9, ip: "10.0.0.8"},
            Status: "claimed",
            UpdatedAt: "2020-08-18 11:38:48.0 +0200 CEST"
        }],
        userInput: {})
}

mutation TestAllocationStrat_ipv4Prefix_full {
    TestAllocationStrategy(
        allocationStrategyId: 1,
        resourcePool: { ResourcePoolName: "10.0.0.0/8"},
        currentResources: [
            {Properties: { prefix: 9, ip: "10.0.0.8"},
                Status: "claimed",
                UpdatedAt: "2020-08-18 11:38:48.0 +0200 CEST"
            },
            {Properties: { prefix: 9, ip: "10.128.0.8"},
                Status: "claimed",
                UpdatedAt: "2020-08-18 11:38:48.0 +0200 CEST"
            }],
        userInput: {})
}

mutation createResourceType_ipv4Address {
    CreateResourceType(
        resourceName: "ipv4_address",
        resourceProperties: {
            ip: "string",
        }
    ) {
        ID
    }
}

mutation CreateIpv4AddressAllocationStratJs {
    CreateAllocationStrategy(
        name: "ipv4_address_from_subnet",
        description: "This strategy allocates ipv4 addresses from a subnet represented by a prefix"
        script: """

        function inet_ntoa(addrint) {
        return ((addrint >> 24) & 0xff) + "." +
        ((addrint >> 16) & 0xff) + "." +
        ((addrint >> 8) & 0xff) + "." +
        (addrint & 0xff);
        }

        function inet_aton(addrstr) {
        var re = /^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/;
        var res = re.exec(addrstr);

        if (res === null) {
        return null;
        }

        for (var i = 1; i <= 4; i++) {
        if (res[i] < 0 || res[i] > 255) {
        return null;
        }
        }

        return (res[1] << 24) | (res[2] << 16) | (res[3] << 8) | res[4];
        }

        function subnet_addresses(mask)
        {
        return 1<<(32-mask);
        }

        const prefixRegex = /([0-9.]+)\/([0-9]{1,2})/;

        function parse_prefix(str) {
        let res = prefixRegex.exec(str);
        if (res == null) {
        return null
        }

        return {
        "address": res[1],
        "prefix": parseInt(res[2], 10)
        }
        }

        function invoke() {
        let rootPrefix = resourcePool.ResourcePoolName

        let rootPrefixParsed = parse_prefix(rootPrefix)
        if (rootPrefixParsed == null) {
        console.error("Unable to extract root prefix from pool name: " + rootPrefix)
        return null
        }

        let addrStr = rootPrefixParsed.address
        let mask = rootPrefixParsed.prefix

        if (currentResources.length === 0) {
        let addrInt = inet_aton(addrStr);
        return {
        "ip": inet_ntoa(addrInt + 1),
        }
        } else if (currentResources.length + 2 >= subnet_addresses(mask)) {
        console.error("No more free resources")
        return null
        } else {
        let addrInt = inet_aton(addrStr);
        return {
        "ip": inet_ntoa(addrInt + currentResources.length + 1),
        }
        }
        }

        """,
        lang: js
    ){
        ID
    }
}

mutation TestIpv4AddrAllocationStrat_1 {
    TestAllocationStrategy(
        allocationStrategyId: 2,
        resourcePool: { ResourcePoolName: "10.0.0.0/8"},
        currentResources: [],
        userInput: {})
}

# Root pool
mutation CreateRootPool_allocating {
    CreateAllocatingPool(input: {
        resourceTypeId: 21474836480,
        poolName: "10.0.0.0/8",
        allocationStrategyId: 1,
        poolDealocationSafetyPeriod: 0}
    ){
        ID
    }
}

# Pool 10.0.0.0/9 on level #2
mutation ClaimResourceFromRoot {
    ClaimResource(poolId:17179869184, userInput: {}) {
        ID
        Properties
    }
}

mutation CreateLevel2Pool1_allocating {
    CreateNestedAllocatingPool(input: {
        resourceTypeId: 21474836480,
        poolName: "10.0.0.0/9",
        allocationStrategyId: 1,
        poolDealocationSafetyPeriod: 0},
        parentResourceId: 12884901888
    ){
        ID
    }
}

# Pool 10.128.0.0/9 on level #2
mutation ClaimResourceFromRoot {
    ClaimResource(poolId:17179869184, userInput: {}) {
        ID
        Properties
    }
}

mutation CreateLevel2Pool2_set {
    CreateNestedSetPool(input: {
        resourceTypeId: 21474836480,
        poolName: "10.128.0.0/9",
        poolValues: [{ip: "10.128.0.0", prefix: 10}, {ip: "10.192.0.0", prefix: 10},],
        poolDealocationSafetyPeriod: 0},
        parentResourceId: 12884901889
    ){
        ID
    }
}

# Pool 10.0.0.0/10 on level #3
mutation ClaimResourceFromLevel2Pool1 {
    ClaimResource(poolId:17179869185, userInput: {}) {
        ID
        Properties
    }
}

mutation CreateLevel3Pool1_singleton {
    CreateNestedSingletonPool(input: {
        resourceTypeId: 21474836480,
        poolName: "10.0.0.0/10",
        poolValues: [{ip: "10.10.0.0", prefix: 11},]},
        parentResourceId: 12884901892
    ){
        ID
    }
}

# Pool 10.64.0.0/10 on level #3
mutation ClaimResourceFromLevel2Pool1 {
    ClaimResource(poolId:17179869185, userInput: {}) {
        ID
        Properties
    }
}

mutation CreateLevel2Pool1_allocating {
    CreateNestedAllocatingPool(input: {
        resourceTypeId: 21474836481,
        poolName: "10.64.0.0/10",
        allocationStrategyId: 2,
        poolDealocationSafetyPeriod: 0},
        parentResourceId: 12884901894
    ){
        ID
    }
}

mutation ClaimResourceFromLevel3Pool2_ips_from_10_64_0_0__10 {
    ClaimResource(poolId:17179869188, userInput: {}) {
        ID
        Properties
    }
}

# Pool 10.128.0.0/10 on level #3
mutation ClaimResourceFromLevel2Pool2 {
    ClaimResource(poolId:17179869186, userInput: {}) {
        ID
        Properties
    }
}

mutation CreateLevel3Pool3_allocating {
    CreateNestedAllocatingPool(input: {
        resourceTypeId: 21474836481,
        poolName: "10.128.0.0/10",
        allocationStrategyId: 2,
        poolDealocationSafetyPeriod: 0},
        parentResourceId: 12884901890
    ){
        ID
    }
}

mutation ClaimResourceFromLevel3Pool2_ips_from_10_128_0_0__10 {
    ClaimResource(poolId:17179869189, userInput: {}) {
        ID
        Properties
    }
}

# Pool 10.192.0.0/10 on level #3
mutation ClaimResourceFromLevel2Pool2 {
    ClaimResource(poolId:17179869186, userInput: {}) {
        ID
        Properties
    }
}

mutation CreateLevel3Pool3_allocating {
    CreateNestedAllocatingPool(input: {
        resourceTypeId: 21474836481,
        poolName: "10.192.0.0/10",
        allocationStrategyId: 2,
        poolDealocationSafetyPeriod: 0},
        parentResourceId: 12884901891
    ){
        ID
    }
}

mutation ClaimResourceFromLevel3Pool2_ips_from_10_92_0_0__10 {
    ClaimResource(poolId:17179869190, userInput: {}) {
        ID
        Properties
    }
}

query QueryPoolHierarchy_3LevelsDeep {
    QueryResources(poolId: 17179869184) {
        # Resources from root pool
        ID
        Properties

        # Level 2 pools
        NestedPool {
            ID
            Name
            PoolType
            Resources {
                ID
                Properties

                # Level 3 pools
                NestedPool {
                    ID
                    Name
                    PoolType
                    Resources {
                        ID
                        Properties
                    }
                }

            }
        }

    }
}

query QueryOnlyIpv4PrefixPools {
    QueryResourcePools(resourceTypeId: 21474836480) {
        ID
        Name
    }
}

query QueryOnlyIpv4AddrPools {
    QueryResourcePools(resourceTypeId: 21474836481) {
        ID
        Name
    }
}

query QueryIpv4PrefixRootPools {
    QueryRootResourcePools(resourceTypeId: 21474836480) {
        ID
        Name
    }
}

query QueryIpv4AddressLeafPools {
    QueryLeafResourcePools(resourceTypeId: 21474836481) {
        ID
        Name
    }
}

# TODO pool properties ? where does root pool store its root prefix ?